<?xml version="1.0" encoding="ASCII"?>
<pipeline:WorkflowFile xmi:version="2.0" xmlns:xmi="http://www.omg.org/XMI" xmlns:pipeline="pipeline" name="Pipeline">
  <on>
    <events eventType="push">
      <branches name="main"/>
      <branches name="develop"/>
    </events>
    <events eventType="pull_request">
      <branches name="main"/>
    </events>
  </on>
  <jobs name="build" runsOn="ubuntu-latest">
    <env key="JAVA_HOME" value="/usr/lib/jvm/java-11"/>
    <env key="MAVEN_OPTS" value="-Xmx1024m"/>
    <steps name="Checkout code" uses="actions/checkout@v3"/>
    <steps name="Set up JDK 11" uses="actions/setup-java@v3">
      <with key="java-version" value="11"/>
      <with key="distribution" value="temurin"/>
    </steps>
    <steps name="Build with Maven" run="mvn clean package -DskipTests"/>
  </jobs>
  <jobs name="test" runsOn="ubuntu-latest">
    <needs>build</needs>
    <steps name="Checkout code" uses="actions/checkout@v3"/>
    <steps name="Set up JDK 11" uses="actions/setup-java@v3">
      <with key="java-version" value="11"/>
      <with key="distribution" value="temurin"/>
    </steps>
    <steps name="Run tests" run="mvn test"/>
  </jobs>
  <jobs name="deploy" runsOn="ubuntu-latest">
    <needs>test</needs>
    <steps name="Checkout code" uses="actions/checkout@v3"/>
    <steps name="Login to Docker Hub" uses="docker/login-action@v2">
      <with key="username" value="${{ secrets.DOCKERHUB_USERNAME }}"/>
      <with key="password" value="${{ secrets.DOCKERHUB_TOKEN }}"/>
    </steps>
    <steps name="Build and push Docker image" uses="docker/build-push-action@v4">
      <with key="push" value="true"/>
      <with key="tags" value="${{ secrets.DOCKERHUB_USERNAME }}/myapp:latest"/>
    </steps>
  </jobs>
</pipeline:WorkflowFile>